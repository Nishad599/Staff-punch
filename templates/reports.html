<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Punch Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .nav-link { transition: all 0.2s ease; }
        .nav-link:hover { background: #e0f2fe; }
        .nav-link.active { background: #0891b2; color: white; }
        table { border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg">
            <div class="p-6 border-b">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-cyan-500 rounded-lg flex items-center justify-center">
                        <span class="text-xl">‚è±Ô∏è</span>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800">Punch System</h1>
                        <p class="text-xs text-gray-500">Admin Panel</p>
                    </div>
                </div>
            </div>
            <nav class="p-4 space-y-2">
                <a href="/dashboard" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>üìä</span> Dashboard
                </a>
                <a href="/employees" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>üë•</span> Employees
                </a>
                <a href="/register" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>‚ûï</span> Register New
                </a>
                <a href="/calendar" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>üìÖ</span> Calendar View
                </a>
                <a href="/reports" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <span>üìà</span> Reports
                </a>
                <a href="/monthly-report" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>üìã</span> Monthly Report
                </a>
                <a href="/punch" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>üì∏</span> Punch Terminal
                </a>
                <hr class="my-4">
                <a href="/" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 font-medium">
                    <span>üè†</span> Home
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Attendance Reports</h1>
                <p class="text-gray-500">View working hours, regular time, and overtime</p>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="start-date" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                        <input type="date" id="end-date" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Employee</label>
                        <select id="emp-filter" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-cyan-500 outline-none">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReport()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-lg font-semibold transition">
                            üîç Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-5 rounded-xl shadow">
                    <p class="text-gray-500 text-sm">Total Records</p>
                    <p class="text-3xl font-bold text-gray-800" id="summary-records">0</p>
                </div>
                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 p-5 rounded-xl shadow text-white">
                    <p class="text-cyan-100 text-sm">Total Hours</p>
                    <p class="text-3xl font-bold" id="summary-total">0h</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-5 rounded-xl shadow text-white">
                    <p class="text-green-100 text-sm">Regular Hours</p>
                    <p class="text-3xl font-bold" id="summary-regular">0h</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-amber-600 p-5 rounded-xl shadow text-white">
                    <p class="text-orange-100 text-sm">Overtime Hours</p>
                    <p class="text-3xl font-bold" id="summary-overtime">0h</p>
                </div>
            </div>

            <!-- Report Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">üìã Detailed Report</h2>
                    <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        üì• Export CSV
                    </button>
                </div>
                <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600 border-b">
                                <th class="p-4">Date</th>
                                <th class="p-4">Employee ID</th>
                                <th class="p-4">Name</th>
                                <th class="p-4">Punch In</th>
                                <th class="p-4">Punch Out</th>
                                <th class="p-4 text-center">Total Hours</th>
                                <th class="p-4 text-center">Regular</th>
                                <th class="p-4 text-center">Overtime</th>
                                <th class="p-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-tbody">
                            <tr>
                                <td colspan="9" class="p-8 text-center text-gray-500">
                                    Select date range and click "Generate Report"
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Employee Summary Section -->
            <div class="mt-8 bg-white rounded-xl shadow p-6" id="employee-summary-section" style="display: none;">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üë§ Employee-wise Summary</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600 border-b">
                                <th class="p-3">Employee</th>
                                <th class="p-3 text-center">Days Worked</th>
                                <th class="p-3 text-center">Total Hours</th>
                                <th class="p-3 text-center">Regular Hours</th>
                                <th class="p-3 text-center">Overtime Hours</th>
                                <th class="p-3 text-center">Avg Hours/Day</th>
                            </tr>
                        </thead>
                        <tbody id="emp-summary-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let reportData = [];

        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('start-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
        }

        // Load employees for filter
        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('emp-filter');
                    data.employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.emp_id;
                        option.textContent = `${emp.emp_name} (${emp.emp_id})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load employees:', error);
            }
        }

        // Load report
        async function loadReport() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const empId = document.getElementById('emp-filter').value;

            if (!startDate || !endDate) {
                alert('Please select date range');
                return;
            }

            try {
                let url = `/api/attendance/report?start_date=${startDate}&end_date=${endDate}`;
                if (empId) url += `&emp_id=${empId}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    reportData = data.records;
                    renderReport(data.records, data.summary);
                    renderEmployeeSummary(data.records);
                }
            } catch (error) {
                console.error('Failed to load report:', error);
            }
        }

        function renderReport(records, summary) {
            // Update summary cards
            document.getElementById('summary-records').textContent = summary.total_records;
            document.getElementById('summary-total').textContent = summary.total_hours + 'h';
            document.getElementById('summary-regular').textContent = summary.total_regular_hours + 'h';
            document.getElementById('summary-overtime').textContent = summary.total_overtime_hours + 'h';

            // Render table
            const tbody = document.getElementById('report-tbody');

            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="p-8 text-center text-gray-500">
                            No records found for the selected period
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = records.map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">${r.punch_date}</td>
                    <td class="p-4 font-medium">${r.emp_id}</td>
                    <td class="p-4">${r.emp_name}</td>
                    <td class="p-4">
                        ${r.punch_in_time ? new Date(r.punch_in_time).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : '-'}
                    </td>
                    <td class="p-4">
                        ${r.punch_out_time ? new Date(r.punch_out_time).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : '-'}
                    </td>
                    <td class="p-4 text-center font-semibold">${r.total_hours || 0}h</td>
                    <td class="p-4 text-center text-green-600 font-medium">${r.regular_hours || 0}h</td>
                    <td class="p-4 text-center">
                        ${r.overtime_hours > 0 
                            ? `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-sm font-medium">${r.overtime_hours}h OT</span>` 
                            : '<span class="text-gray-400">-</span>'}
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${
                            r.status === 'completed' 
                                ? 'bg-green-100 text-green-700' 
                                : r.status === 'punched_in'
                                    ? 'bg-yellow-100 text-yellow-700'
                                    : 'bg-gray-100 text-gray-600'
                        }">
                            ${r.status === 'completed' ? '‚úÖ Complete' : r.status === 'punched_in' ? 'üü° Working' : r.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderEmployeeSummary(records) {
            const section = document.getElementById('employee-summary-section');
            const tbody = document.getElementById('emp-summary-tbody');

            if (records.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Group by employee
            const empData = {};
            records.forEach(r => {
                if (r.status !== 'completed') return;
                
                if (!empData[r.emp_id]) {
                    empData[r.emp_id] = {
                        emp_name: r.emp_name,
                        days: 0,
                        total: 0,
                        regular: 0,
                        overtime: 0
                    };
                }
                empData[r.emp_id].days++;
                empData[r.emp_id].total += r.total_hours || 0;
                empData[r.emp_id].regular += r.regular_hours || 0;
                empData[r.emp_id].overtime += r.overtime_hours || 0;
            });

            tbody.innerHTML = Object.entries(empData).map(([empId, data]) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">
                        <div class="font-medium">${data.emp_name}</div>
                        <div class="text-sm text-gray-500">${empId}</div>
                    </td>
                    <td class="p-3 text-center font-medium">${data.days}</td>
                    <td class="p-3 text-center font-bold text-cyan-600">${data.total.toFixed(1)}h</td>
                    <td class="p-3 text-center text-green-600">${data.regular.toFixed(1)}h</td>
                    <td class="p-3 text-center">
                        ${data.overtime > 0 
                            ? `<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-medium">${data.overtime.toFixed(1)}h</span>`
                            : '-'}
                    </td>
                    <td class="p-3 text-center text-gray-600">${(data.total / data.days).toFixed(1)}h</td>
                </tr>
            `).join('');
        }

        function exportCSV() {
            if (reportData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Employee ID', 'Name', 'Phone', 'Punch In', 'Punch Out', 'Total Hours', 'Regular Hours', 'Overtime Hours', 'Status'];
            const rows = reportData.map(r => [
                r.punch_date,
                r.emp_id,
                r.emp_name,
                r.phone || '',
                r.punch_in_time || '',
                r.punch_out_time || '',
                r.total_hours || 0,
                r.regular_hours || 0,
                r.overtime_hours || 0,
                r.status
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_report_${document.getElementById('start-date').value}_to_${document.getElementById('end-date').value}.csv`;
            a.click();
        }

        // Initialize
        setDefaultDates();
        loadEmployees();
    </script>
</body>
</html>
